
buildscript {
    if (System.getProperty("kotlinVersion") == null) {
        System.setProperty('kotlinVersion', '1.2.71')
    }

    repositories {
        maven { url 'https://nexus.yamoney.ru/content/repositories/central/' }

        dependencies {
            classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:${System.getProperty('kotlinVersion')}"
        }
    }
}

apply plugin: org.jetbrains.kotlin.gradle.plugin.KotlinPluginWrapper

sourceSets {
    test.java.srcDirs += 'src/test/kotlin'

    slowTest {
        kotlin {
            compileClasspath += main.output + test.output
            runtimeClasspath += main.output + test.output
            srcDir file('src/slowTest/kotlin')
        }
    }
}

afterEvaluate {
    /**
     * Так как пользуемся Kotlin только в тестах, то убираем зависимость на таску компиляции Kotlin.
     * Она нарушает последовательность тасок для генерациия Jooq сущностей, тем самым приводит к ошибкам компиляции Java.
     */
    compileJava.dependsOn.remove(project.tasks.compileKotlin)

    dependencies {
        testCompile "org.jetbrains.kotlin:kotlin-stdlib:${System.getProperty('kotlinVersion')}",
                "org.jetbrains.kotlin:kotlin-reflect:${System.getProperty('kotlinVersion')}",
                "org.jetbrains.kotlin:kotlin-stdlib-jdk8:${System.getProperty('kotlinVersion')}"
    }
}
